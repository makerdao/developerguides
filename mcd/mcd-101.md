# MCD 101

A comprehensive overview of the smart contracts within the Dai Credit System.

### Sections
1. [Problem and Solution](#problem-and-solution)
2. [Dai and CDP Mechanisms](#dai-and-cdp-mechanisms)
3. [Sai vs Dai](#sai-vs-dai)
4. [Quick Vocabulary](#quick-vocabulary---general)
5. [Smart Contract Modules](#smart-contract-modules)
6. [Advanced Concepts](#advanced-concepts)

## Problem and Solution
The ultimate guage of capital is denominated in the Global Currency, which is US Dollars (USD).

Is Bitcoin stable relative to the Global Currency?

<img align="middle" width="600" border="1" src="./pictures/bitcoinChart.png">



**Problem**: No, bitcoin, ethereum, and other cryptocurrencies are not stable relative to the USD.

**Solution**: Dai

### MakerDAO's Flapship Product

<img align="right" width="225" style="padding: 20px" height="200" src="./pictures/daipeg.png">

Dai Stablecoin
* 1 Dai ~= 1 USD
* Basic user
* Fully backed by Collateral





<br/>
<br/>

## Dai and CDP mechanisms

### Economics

**How does it keep its peg?**

<img align="right" width="300" height="275" style="padding: 20px" src="./pictures/supplyDemand.png">

* Demand curve can shift due to market conditions, confidence of Dai holders, etc

* Supply curve is shifted through a permissionless credit factory on Ethereum

* Any actor can vary the supply of Dai through a Collateralized Debt Position (CDP)

* The system was built so that these actors are incentivized to shift the supply curve to ensure that the price is $1


<br/>
<br/>

### CDP

<img align="right" width="300" height="275" style="padding: 20px" src="./pictures/CDP.png">

**Collateralized Debt Position (CDP)**


  * Borrow Dai through locking up cryptoassets as collateral

  * Repay Dai + fee to retrieve collateral

  * Safe, over-collateralized CDP >

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

<img align="right" width="300" height="275" style="padding: 20px" src="./pictures/house.png">

**Analogous to a Mortgage**


* Bank gives you a loan by “locking” ownership rights with them

* Repay debt + interest to “free” the bank’s ownership of the house

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

<img align="right" width="300" height="275" style="padding: 20px" src="./pictures/auction.png">

**Liquidations**

1. CDP is automatically liquidated if the collateral value (in USD) falls too low

2. Part of the collateral is auctioned off to cover the outstanding debt + penalty fee

3. Dai is then burned to decrease the supply

  CDP owner receives the leftover collateral


<br/>
<br/>
<br/>

### System Interaction Diagram

<img width="600" align="middle" src="./pictures/interactionD.png">


#### Users

| Name        |  Type | Description |
| ----------- | ----------- | --------- |
| Dai Holders | Basic - No additional knowledge to own Dai | Stability Seekers; Consumer; Businesses|
| CDP Owners  | Intermediate - Some knowledge | Risk Seekers; Speculators; Borrowers|
<br/>

#### Maintainers

| Name        |  Type | Description |
| ----------- | ----------- | --------- |
| Developers | Advanced - Extensive knowledge | Supports system upgrades accepted by Governors|
| Oracles  | Intermediate - Some knowledge | Supports data feed from real world to blockchain|
| Keepers | Advanced - Extensive knowledge | Builds/maintains systems that profit off system discrepancies and participate in DCS auctions |
<br/>


#### Governors

| Name        |  Type | Description |
| ----------- | ----------- | --------- |
| MKR Holders | Advanced - Extensive knowledge | Monitor, partake, and vote on upgrades/changes in DCS|
| Risk Teams | Advanced - Extensive knowledge | Collect/compile relevant data and develop risk models, assessed by MKR Holders|
<br/>


**Anyone with the required knowledge can freely participate in any role**

**Any one person (or service) can have multiple roles**


<br/>

### System Lines of Defense

At any point, the system must have more value in collateral than value of Dai supply. The following mechanisms help maintain system solvency:

1. **Supply and Demand** - supply and demand of CDPs (and thus Dai) is influenced by the Stability Fees and Debt Ceiling adjustments

2. **Liquidation** - any time the collateral value of a CDP gets closer to its debt, it becomes “risky-er”. The system liquidates CDPs that get too risky

3. **MKR Minting/Burning** - Incentivized to Govern prudently, MKR Holders are rewarded from MKR burning when Stability Fees are paid. However, if the DCS accrues too much bad debt, MKR is minted to cover the deficit.

4. **Emergency Shutdown** - This is a process that is used as a last resort in cases of extreme market irrationality, attacks, or coordinated upgrades. Emergency Shutdown gracefully settles the Maker Platform while ensuring that all users, both Dai holders and CDP users, receive the net value of assets they are entitled to.





<br/>
<br/>
<br/>
<br/>

## Sai vs Dai

| Single Collateral Dai        |  Multi Collateral Dai |
| ----------- | ----------- |
| Single collateral type backing Dai | Multi. collateral types backing Dai |
| Less diversified | Collateral can be many assets |
| Liquidations occur at a fixed discount to the current collateral price | Liquidations are handled using Auctions|
| MKR used to pay stability fee | Dai used to pay stability fee |
| Decentralized governance through MKR voting rights| Decentralized governance through MKR voting rights|
| ----- |  More diversified and stable |

<br/>
<br/>

## Quick Vocabulary - General

**Risk Parameters** - system variables adjusted through MKR governance to control various types of risk.
Important parameters for each collateral type:
* **Stability fee** - a fee that continuously accrues on debt in a CDP (e.g. 0.5% per year)
* **Debt ceiling** - max amount of Dai minted for a given collateral type (e.g. 10 million Dai)
* **Liquidation ratio** - required amount of collateral as a proportion of a CDP’s total debt (e.g. 150%)

`ilk` - collateral type; each has their own set of risk parameters <br/>
`urn` - collateralized debt position; a CDP owner can control one urn per collateral type <br/>
`gem` - unlocked collateral; gem is collateral that is not yet locked in a CDP but still recorded in the system <br/>
`sin` - system debt unit; a debt token that is tracked during liquidation process <br/>
`dai` - stablecoin; a good debt token
<br/>
<br/>
<br/>

### Quick Vocabulary - Rates

* **Risk Premium Rate** - This rate is used to calculate the risk premium fee that accrues on debt in a CDP. A unique Risk Premium Rate is assigned to each collateral type.  (e.g. 2.5%/year for Collateral A, 3.5%/year for Collateral B, etc) <br/>
* **Base Rate** - This rate is used to calculate the base fee that accrues on debt in a CDP. A system wide Base Rate is assigned to all collateral types. (e.g. 0.5%/year for the Dai Credit System) <br/>
* **Stability Rate** = _Risk Premium Rate + Base Rate_. This rate is used to calculate the **Stability Fee**. <br/>
* **Savings Rate** - This rate is used to calculate the interest that accrues on Savings Dai. A system wide Savings Rate is assigned to all Savings Dai. (e.g. 1%/year for Savings Dai)

**All rates accrue regularly on a per second basis.**
<br/>
<br/>
<br/>

### Motivations on Concise Jargon

* **To sidestep terminological debates** - for example, whether to say rate of target price change or target rate <br/>
* **To decouple financial and technical vocabularies** - we can more flexibly improve one without affecting the other. <br/>
* **To discuss the system formally** - this ability, with the financial interpretation partly suspended, has suggested insights that would have been harder to think of inside the normal language. <br/>
* **To better formalize the implementation** - the precise and distinctive language makes the structure and logic of the implementation more apparent and easier to formalize. <br/>
* **To decrease verbosity** - concise names make the code less verbose and the concepts easier to handle on paper, whiteboard, etc.

<br/>
<br/>
<br/>

## Smart Contract Modules

#### Core Module
The core module contains the state of the Dai Credit System (DCS) and its central mechanisms while in normal operation.

Components - `Vat`, `Cat`, `Spotter`

What are the components?
* `Vat` - **The single source of truth for the Dai Credit System.** It contains the accounting system of the core CDP, Internal Dai balances, and collateral state. The Vat has no external dependencies and maintains the central "Accounting Invariants" of Dai. It houses the public interface for CDP management, allowing urn (cdp) owners to adjust their CDP state balances. It also contains the public interface for CDP fungibility, allowing urn (cdp) owners to transfer, split, and merge CDPs. Excluding these interfaces, the Vat is accessed through trusted smart contract modules.
* `Cat` - Public interface for **confiscating unsafe urns (cdps)** and processing seized collateral via their respective flip (collateral) auction.
* `Spotter` - Allows external actors to update the price feed in Vat for a given Ilk (collateral type).

Why do we have them?

* `Vat` - def. “a large tank or tub used to hold liquid”

  **The Vat holds the fundamental primitives of the Dai Credit System:**
  * Database - Risk parameters as well as Dai, Sin, collateral, and debt balances
  * Accounting System - Basic accounting operations to update the Database
  * CDP Management - Adjustment of locked collateral and debt position (Dai creation)
  * CDP Fungibility - Ability to transfer, split and merge CDPs

  The Vat and these primitives are designed to be non-upgradable or replaceable. <br/>
  Other components of the system, such as auctions, oracles, and rate accumulators, are subject to future development. Their business logic has been contained within their own smart contract modules as an upgradable interface between the user and the Vat. Since these subsystems have access to more complex operations within the Vat, module upgrades are voted in by MKR holders. Through CDP management/fungibility, direct access to the Vat provides a strong guarantee to users that the basic semantics/interface aren’t going to change. <br/>
  https://github.com/makerdao/dss/wiki/Vat


* `Cat` - def. “A domesticated, carnivorous mammal”

  **The Cat “bites” CDPs that are too risky.** <br/>
  The minter of Dai is a CDP owner and the “borrower”, while the smart contract system is the “lender”. To increase the borrower’s confidence in the minted value lent out, the lender requires all minted Dai to be fully backed by an asset with value that is proven in free markets. If the value of the underlying asset dips below the required amount, the collateralization ratio (USD value of asset / USD value of Dai debt) decreases. To increase this ratio and prevent insolvency of the system, the lender takes (via Cat) the collateral and sells it for Dai in an auction (Flipper). <br/>
  Remember: 1 Dai must always be backed by more than 1 USD worth of assets. <br/>
  https://github.com/makerdao/dss/wiki/Cat


* `Spotter` - def. “an aviator or aircraft employed in locating or observing enemy positions” <br/>

  The Dai Credit System requires real time information about the market price of the assets used as collateral in CDPs. Ultimately, this market price determines the amount of Dai that can be minted, as well as the grab condition for CDP liquidations. The oracle module handles how markets prices are recorded on the blockchain. <br/>

  The Spotter is simply **an interface contract** where external actors pull the **current market price** from the Oracle module for the **specified collateral type**. The Vat reads the market price from the spotter. <br/>
  https://github.com/makerdao/dss/wiki/Spot

***

#### Collateral Module
The collateral module is deployed for every new ilk (collateral type) added to Vat. It contains all adapters and auction contract for one collateral type. All token behavior is abstracted behind these adapters.

Components - `Join`, `Flipper`

What are these components?

  * `Join` - The Join adapter is **used to deposit unlocked collateral** into the Vat. Currently, GemJoin is only compatible with standard ERC20 tokens, but eventually there will be various types of Join adapters that are compatible with different Token Standards.
  * `Flipper` - **Gem auction house**. Each gem/flip auction is unique and linked to a previously bitten urn (cdp). Investors bid with increasing amounts of DAI for a fixed GEM amount. When the DAI balance deficit is covered, bidders continue to bid for a decreasing gem size until the auction is complete. Remaining GEM is returned to the CDP owner.

Why do we have them?

* `Join` - def. of Gem - “a precious or semiprecious stone” <br/>
  To retain the security of the system, only trusted smart contracts can interact with the Vat. A Join adapter is a trusted smart contract that is used to **deposit unlocked collateral** within the Vat. The location of collateral deposited/locked in CDPs is in the the appropriate Join adapter.
  https://github.com/makerdao/dss/wiki/Gem

* `Flipper` - def. of Flip - “turn over or cause to turn over with a sudden sharp movement.” <br/>
  The purpose of the gem auction house is to decrease the market risk of collateral backing Dai. It sells an amount of seized gem to **purchase and burn Dai**, which will **increase the collateralization ratio** of the system, away from insolvency. https://github.com/makerdao/dss/wiki/Fuss
<br/> <br/>
  Priorities for the Flipper:
  * Cover the amount of total debt (minted Dai + accrued fees) of the CDP
  * Return as much collateral back to the CDP owner as possible

#### Dai Module
_Fundamentally, "Dai" is any token that is directly fungible with the core collateral._ <br/>
The dai module contains the dai token representation and all adapters thereof.


Components - `Dai`, `DaiJoin`

What are these components?

* `Dai` - An extension to the standard ERC20 token interface. Contains the database of Dai token owners, transfer and supply logic.

* `DaiJoin` - DaiJoin is an adapter where all Dai tokens are created. The CDP owner interacts with DaiJoin to mint the Dai tokens that has been allocated for them in the Vat as well as burn Dai Tokens + fees accrued against their CDP.


Why do we have them?

* `Dai` is an extension of DS-Token, which is part of DappSys, a safe, simple, flexible library for smart-contract systems. <br/>

  DSToken is an implementation that supports the ERC20 Standard, but with a few additions that complement the design of the Dai Credit System:
  * _Addition of mint and burn functions (with proper authorization)_ -> to control token supply <br/>
  * _Push, pull and move aliases for transferFrom operations_ -> improves readability <br/>
  * _Binary allowance approval_ -> lower gas and higher security <br/>

* `DaiJoin` <br/>
  To retain the security of the system, only trusted smart contracts can interact with the Vat. DaiJoin is a trusted smart contract that is used to deposit Dai into the Vat. **All minting and burning of Dai tokens happens in DaiJoin** (think “United States Mint”).
  https://github.com/makerdao/dss/wiki/Dai

***

#### System Stabilizer Module
When the value of the collateral backing Dai drops below the liquidation level, then the stability of the system is at risk. The System stabilizer module sets up incentives for Keepers (incentivized external actors) to step in, push the system back to a safe state, and earn profits.

Components - `Vow`, `Flopper`, `Flapper`

What are these components?

* `Vow` - The Vow represents the **DCS’s balance**, as the recipient of both system surplus and system debt. Its function is to cover deficits via debt auctions and discharge surpluses via surplus auctions. <br/>

* `Flopper` - Debt Auction house. Debt auctions are used to get rid of the Vow’s debt by auctioning off MKR for a fixed size of internal Dai. **Bidders compete with decreasing “amount requests” of MKR**. After auction settlement, the Flopper sends the received internal Dai to the Vow to cancel out its debt. The Flopper mints the MKR for the winning bidder. <br/>

* `Flapper` - Surplus Auction house. Surplus auctions are used to get rid of the Vow’s surplus by auctioning off a fixed size of internal Dai for MKR. **Bidders compete with increasing amounts of MKR**. After auction settlement, the Flapper burns the winning MKR bid and sends the internal Dai to the winning bidder. For this reason, surplus auctions are **also known as Buy & Burn auctions**  <br/>

Why do we have them?

* `Vow` - def. “a solemn promise.”

  The Dai Credit System deviates from equilibrium when it receives system debt and system surplus through collateral auctions and CDP stability fee accumulation, respectively. The Vow houses the business logic to kick off debt and surplus auctions, which correct the system’s monetary imbalances.

  System debt: **When CDPs are bitten**, their debt is taken on by the Vow as Sin, the system debt unit, and placed in the Sin queue. If this Sin is not covered by a flip auction within some wait time, the Sin “matures” and is now considered bad debt to the Vow. This bad debt can be covered through a debt auction when it amounts to its lot size. <br/>

  System surplus: **Stability fee accumulation** occurs in the form of additional internal Dai to the Vow. This surplus is then discharged through surplus auctions.
  https://github.com/makerdao/dss/wiki/Vow

* `Flopper` - def. of Flop - “be completely unsuccessful; fail totally”

  The purpose of the debt auction is to cover the system deficit, which is resembled by Sin. It sells an amount of minted MKR and purchases Dai to be canceled 1-to-1 with Sin.

  Priorities for the Flopper:
  1. Raise an amount of Dai equivalent to the amount of bad debt **as fast as possible**
  2. Minimize the amount of MKR inflation


* `Flapper` - def of Flap - “(of a bird) move (its wings) up and down when flying or preparing to fly”

  The purpose of the surplus auction is to release Dai surplus from the Vow as well as reward the MKR holders in the form of MKR deflation. It sells a fixed amount of Dai to purchase and burn MKR.

  Priorities for the Flapper: **Burn as much MKR as possible** when auctioning surplus

  https://github.com/makerdao/dss/wiki/Fuss

***

#### Oracle Module
Add image here
The value of collateral in a CDP is derived from its global, free market USD price. An oracle module is deployed for each collateral type. It feeds price data for a corresponding collateral type to the Vat.  Whitelisted addresses broadcast price updates off-chain, which are fed into a medianizer before being pulled into the OSM. The Spotter reads from the OSM.

Components - `Medianizer`, `OSM`

What and why these components?

* `Medianizer` - For a specific Ilk, the Medianizer returns the median value of several price feeds, fed from the off-chain Omnia Relayer Network. A median value is determined to mitigate the variability in single data points.

* `OSM` (Oracle Security Module) - Authorized users are allowed to set a value after some duration of time (e.g. one hour). To protect the system from an attacker who gains control of a majority of the oracles, the OSM imposes a **1 hour delay on price feeds**, leaving enough time for the MKR governance community and emergency oracles to analyze the data and react.

***

#### MKR Module
The Mkr module contains the MKR token representation.

As a **utility token**: MKR is burned relative to the stability fee accrued on CDPs. This burning happens in the Flapper auction house. This deflates MKR supply and rewards holders for proper governance. <br/>
As a **governance token**: MKR is used by MKR holders to vote for the risk management and business logic of the Dai Credit System. Tokens are a simple representation of voting power. <br/>
As a **recapitalization resource**: MKR is minted and sold for DAI, which is used to recapitalize the Dai Credit System in times of insolvency. This minting happens in a Flopper auction house, inflates MKR supply, and penalizes holders for improper governance.

Components - `DSToken`

What and why these components?

* `DSToken` - An implementation supporting the ERC20 Standard; part of the DappSys (DS) library. Contains database of MKR owners, transfer and supply logic.

***

#### Governance Module
The Governance Module contains the contracts that facilitate MKR voting, proposal execution, and voting security of the Dai Credit System.

Components - `DS-Chief`, `DS-Spell`, `DS-Pause`

What are these components?
* `DS-Chief` - A basic voting contract that grants root access of the DCS to an elected “Chief” (address). Through [Approval Voting](https://en.wikipedia.org/wiki/Approval_voting), voters **lock up their MKR and vote** with a weight relative to the outstanding supply of MKR. Spells (proposals) are a type of Proposal Object and are submitted to DS-Chief under one of two categories:
  * Governance Proposals - Sentiment signaling on system changes
  * Executive Proposals - Execution of system changes

  Anyone can create a Spell, and MKR holders can vote on bundles of Spells, called Slates. At any point, the **Spell (proposal) with the most approval is the elected “Chief”**, has access to and can configure DCS through Mom, the Admin interface contract for Maker Governance.



Why do we have them?



#### Sample Module
Add text here

Components - `Join`, `Flipper`

What are these components?


Why do we have them?




## Advanced Concepts
